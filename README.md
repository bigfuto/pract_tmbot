## Serverless YPD python telegram bot

Serverless Telegram бот на python для API Практикум.Домашка

работающий в Yandex Cloud Functions.

#### Что делает:

Получает список работ от API, сверяет статусы, об изменениях и новых

работах информирует сообщением в телеграм, записывает данные в YDB.

Вспомогательно используется Object Storage для записи сообщения с ошибкой

на случай, например, продолжительной недоступности API, во избежании 

дублирования сообщений.

#### Как запустить:

В Cloud Functions нужно создать функцию, назвать ее, выбрать интерпритатор python. 

Далее нужно перенести файлы бота в созданную функцию:

`index.py` - основные функции.

`constants.py` - константы.

`exceptions.py` - кастомные исключения.

`requirements.txt` - зависимости.

Для этого можно вручную в редакторе создать файлы и скопировать в них

содержимое или воспользоваться загрзкой zip архива (с диска или Object Storage).

Стоит обратить внимание на то, что при скачивании архива с github, файлы 

находятся в директории, а для установки зависимостей `requirements.txt`,

вероятно, должен быть в корне.

После загрузки файлов следует объявить переменные окружения, выбрать 

сервисный аккаунт (потребуется для подключения к БД, Object Storage и

запуска триггера) и указать точку входа, в данном случае - `index.main`.

Для проверки работоспособности можно перейти на вкладку `Тестирование` и запустить 

тест (шаблон и данные указывать не нужно), если результаты теста положительные,

то можно включить запуск приложения по расписанию.

Для этого нужно открыть вкладку `Триггеры`, создать триггер, указать название,

выбрать тип - `Таймер`, настроить таймер, выбрать функцию и сервисный аккаунт.

После этого функция будет запускаться по настроенному таймеру.

Подробнее о Cloud Functions в [документации](https://cloud.yandex.ru/docs/functions/quickstart/)

#### Создание БД:

В Managed Service for YDB нужно создать базу данных, указать имя, тип базы данных

выбрать `Serverless`, в ограничениях можно выставить минимальные значения.

После создания БД нужно создать таблицу, для этого нужно открыть БД, перейти

на вкладку `Навигация` и нажать кнопку `создать` -> `таблицу`. Ввести имя таблицы,

тип `YBD таблица`, и добавить поля, схема полей:
```
Имя                 Ключ        Тип
homework_name        PK         Utf8
date_updated                    Utf8
id                              Uint64
lesson_name                     Utf8
reviewer_comment                Utf8
status                          Utf8
```

Или воспользоваться готовым SQL запросом:

```
CREATE TABLE `works`
(
    `homework_name` Utf8,
    `date_updated` Utf8,
    `id` Uint64,
    `lesson_name` Utf8,
    `reviewer_comment` Utf8,
    `status` Utf8,
    PRIMARY KEY (`homework_name`)
);
```

Данные для подключения к БД находятся во вкладке `Обзор` в разделе `Соединение`.

Подробнее о YDB в [документации](https://cloud.yandex.ru/docs/ydb/quickstart/)

#### Создание бакета в Object Storage:

В Object Storage нужно создать бакет, указать его имя, настройки можно оставить 

без изменений, минимального размера будет более чем достаточно.

Подробнее о Object Storage в [документации](https://cloud.yandex.ru/docs/storage/quickstart/)

Пример python SDK [boto3](https://cloud.yandex.ru/docs/storage/tools/boto)

#### Создание сервисного аккаунта:

В Yandex Cloud открть вкладку `Сервисные аккаунты` и нажать 

`создать сервисный аккаунт`, указать имя и выбрать роль. Для работы

функции нужна роль не менее `editor`. 

Далее нужно открыть аккаунт и `создать новый ключ` -> `статический ключ доступа`.

Обязательно сохраните ключи, после закрытия диалога значение ключа будет недоступно.

#### Переменные окружения:

*Токены*:

`PRACTICUM_TOKEN` - токен API Практикум.Домашка.

`TELEGRAM_TOKEN` - токен телеграм бота.

`TELEGRAM_CHAT_ID` - чат id.

`AWS_ACCESS_KEY_ID` - идентификатор ключа, полученный при создании статического ключа доступа.

`AWS_SECRET_ACCESS_KEY` - секрктный ключ, полученный при создании статического ключа доступа.

*Эндпоинты*:

`YP_ENDPOINT` - эндпоинт API Практикум.Домашка

`S3_ENDPOINT` - эндпоинт Object Storage, можно найти в примере SDK

`YDB_ENDPOINT` - эндпоинт YDB, можно посмотреть во вкладке `'Обзор'` БД

`YDB_DATABASE` - адрес YDB, можно посмотреть во вкладке `'Обзор'` БД

#### Константы:

В `constants.py` загружаются все переменные окружения, поля для проверки эндпоинта,

поля для проверки изменения статуса работы, ключи для формирования телеграм сообщения,

название таблицы БД, колонки для чтения и записи в БД, название бакета

Object Storage и имя файла, в который будет записывать сообщение.

- `KEYS` - основные ключи для работы функции.

  - `TIMESTAMP:`
Передается API Практикум.Домашка в качестве параметра, и т.к. 
проверяются все работы,то по умолчанию ставится равным `0`.

  - `RESPONSE_KEYS:` - ключи проверки ответа эндпоинта.

    - `BASIC` - основной ключ для проверки валидности ответа эндпоинта,
из словаря под этим ключом берется список работ.

    - `OTHER` - второстипенный ключ, проверяется только его наличие в ответе.

  - `PARSE_KEYS:` - ключи проверки изменения статуса работы.

    - `BASIC` - основной ключ для проверки изменения статуса работы, должен 
совпадать c ключом в словаре с данными о работе и с названием колонки в БД.

    - `OTHER` - идентификатор работы, должен совпадать с ключом в словаре 
(с данными о работе) и с названием колонки в БД, колонка в таблице должна
быть *PRIMARY KEY*, по умолчанию `homework_name`, но может быть, например, `id`.

  - `MESSAGE_KEYS:` - ключи для формирования телеграм сообщения.

    - Если `ключ: значение`, то будет сформирована строка:
`значение 'значение из работы по ключу 'ключ''`.

    - Если `ключ: dict`, то будет сформирована строка:
`значение из dict по ключу 'значение из работы по ключу 'ключ''`.

- `TOKENS` - Токены.

- `HEADERS` - Заголовок для авторизации в API.

- `ENDPOINTS` - Эндпоинты.

- `DB_FIELDS:` - Колонки записи и чтения БД.

  - `WRITE` - Колонки БД для записи изменений о работах. Должны совпадать с
  ключами из словаря с работой, обязательны только идентификатор работы и статус,
  берутся из `PARSE_KEYS`. Из полей формируется список с правильным порядком для
  записи, если  ключа в данных о работе нет, то поле будет равно нулю. При изменении
  количества ключей следует изменить шаблон в функции `write_work_in_db`.

  - `READ` - Чтение данных из БД. Значения берутся из `PARSE_KEYS`. После чтения
  формируется словарь: `Идентификатор работы: статус`.

  - `TABLE` - Название таблицы в БД.

- `S3_FIELDS:` - Данные для Object Storage.

  - `BUCKET` - Название бакета.

  - `MESSAGE` - Название файла для хранения сообщения, если он не существует,
  то будет создан при первой записи (если существует, то будет перезаписан при записи).

